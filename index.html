<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crackio Store</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Crackio Store</h1>
  </header>

  <section id="productos"></section>

  <div class="carrito-icono" onclick="mostrarCarrito()">ðŸ›’</div>

  <div id="carrito" class="modal-carrito" style="display: none;">
    <h2>Carrito</h2>
    <div id="lista-carrito"></div>
    <form id="formularioPedido">
      <input type="text" id="nombre" placeholder="Nombre" required>
      <input type="text" id="telefono" placeholder="TelÃ©fono" required>
      <input type="text" id="direccion" placeholder="DirecciÃ³n" required>
      <select id="metodoPago" required>
        <option value="">MÃ©todo de pago</option>
        <option value="Yape">Yape</option>
        <option value="Plin">Plin</option>
        <option value="Efectivo">Efectivo</option>
      </select>
      <textarea id="notas" placeholder="Notas adicionales"></textarea>
      <button type="submit">Enviar pedido</button>
    </form>
    <button onclick="vaciarCarrito()">Vaciar carrito</button>
    <button onclick="cerrarCarrito()">Cerrar</button>
  </div>

  <script>
    const supabase = supabase.createClient('https://twznikjjvtoedfaxbuvf.supabase.co', 'YOUR_PUBLIC_ANON_KEY');

    let carrito = [];

    async function cargarProductos() {
      const { data, error } = await supabase.from('productos').select('*');
      const contenedor = document.getElementById('productos');
      if (error) return console.error('Error cargando productos:', error);

      data.forEach(p => {
        const div = document.createElement('div');
        div.className = 'producto-card';
        div.innerHTML = `
          <img src="${p.imagen}" alt="${p.nombre}" width="200">
          <h3>${p.nombre}</h3>
          <p>S/.${p.precio.toFixed(2)}</p>
          <button onclick='agregarAlCarrito(${JSON.stringify(p)})'>Agregar al carrito</button>
        `;
        contenedor.appendChild(div);
      });
    }

    function agregarAlCarrito(producto) {
      carrito.push(producto);
      alert('Producto agregado');
    }

    function mostrarCarrito() {
      const lista = document.getElementById('lista-carrito');
      lista.innerHTML = '';
      carrito.forEach(p => {
        const item = document.createElement('div');
        item.innerText = `${p.nombre} - S/.${p.precio.toFixed(2)}`;
        lista.appendChild(item);
      });
      document.getElementById('carrito').style.display = 'block';
    }

    function cerrarCarrito() {
      document.getElementById('carrito').style.display = 'none';
    }

    function vaciarCarrito() {
      carrito = [];
      mostrarCarrito();
    }

    document.getElementById('formularioPedido').addEventListener('submit', async e => {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const telefono = document.getElementById('telefono').value;
      const direccion = document.getElementById('direccion').value;
      const metodoPago = document.getElementById('metodoPago').value;
      const notas = document.getElementById('notas').value;

      const total = carrito.reduce((acc, item) => acc + item.precio, 0);
      const productos = carrito.map(p => ({ nombre: p.nombre, precio: p.precio }));

      const { error } = await supabase.from('pedidos').insert([
        {
          nombre_cliente: nombre,
          telefono,
          direccion,
          metodo_pago: metodoPago,
          notas,
          productos,
          total,
          estado: 'pendiente'
        }
      ]);

      if (error) {
        alert('Error al registrar pedido');
        console.error(error);
        return;
      }

      const numeroWhatsApp = '51999999999';
      const mensaje = `Hola, soy ${nombre}.\nQuiero pedir:\n${productos.map(p => `- ${p.nombre} (S/.${p.precio.toFixed(2)})`).join('\n')}\n\nTotal: S/.${total.toFixed(2)}\nDirecciÃ³n: ${direccion}\nPago por: ${metodoPago}\nNotas: ${notas}`;
      const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');

      alert('Pedido registrado. Se abrirÃ¡ WhatsApp');
      vaciarCarrito();
      cerrarCarrito();
    });

    cargarProductos();
  </script>
</body>
</html>
