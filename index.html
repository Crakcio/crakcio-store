<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crackio Store</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Crackio Store</h1>
    <!-- Aquí iría el menú de navegación -->
  </header>

  <main>
    <!-- Productos -->
    <section id="productos"></section>

    <!-- Carrito -->
    <section id="carrito"></section>

    <!-- Formulario de pedido -->
    <section id="seccionPedido">
      <h2>Finalizar Pedido</h2>
      <form id="pedidoForm">
        <input type="text" id="nombreCliente" placeholder="Tu nombre completo" required>
        <input type="text" id="telefonoCliente" placeholder="Tu WhatsApp" required>
        <input type="text" id="direccionCliente" placeholder="Dirección de entrega" required>
        <select id="metodoPago" required>
          <option value="Yape">Yape</option>
          <option value="Plin">Plin</option>
          <option value="Efectivo">Efectivo</option>
        </select>
        <textarea id="notasCliente" placeholder="Notas adicionales (opcional)"></textarea>
        <button type="submit">Enviar Pedido</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Crackio Store. Todos los derechos reservados.</p>
    <a href="politica.html">Política de Privacidad</a> |
    <a href="terminos.html">Términos y Condiciones</a>
  </footer>

  <!-- Supabase + lógica de pedido -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://twznikjjvtoedfaxbuvf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3em5pa2pqdnRvZWRmYXhidXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTI1NDAsImV4cCI6MjA2ODg2ODU0MH0.aOQ10hq-syYqrenvFxveBQj6wKqdDtsDKfykSm42MFE'
    );

    document.getElementById('pedidoForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nombre = document.getElementById('nombreCliente').value.trim();
      const telefono = document.getElementById('telefonoCliente').value.trim();
      const direccion = document.getElementById('direccionCliente').value.trim();
      const metodoPago = document.getElementById('metodoPago').value.trim();
      const notas = document.getElementById('notasCliente').value.trim();
      const productos = JSON.parse(localStorage.getItem('carrito')) || [];

      if (productos.length === 0) {
        alert("Tu carrito está vacío.");
        return;
      }

      const total = productos.reduce((acc, p) => acc + p.precio * p.cantidad, 0);

      const pedido = {
        nombre_cliente: nombre,
        telefono,
        direccion,
        metodo_pago: metodoPago,
        notas,
        productos,
        total,
        estado: "pendiente"
      };

      const { data, error } = await supabase.from("pedidos").insert([pedido]);

      if (error) {
        console.error("❌ Error al guardar pedido:", error);
        alert("Error al registrar tu pedido.");
        return;
      }

      let mensaje = `🛒 *Nuevo pedido Crackio.com*%0A`;
      mensaje += `👤 *Cliente:* ${nombre}%0A📞 *Teléfono:* ${telefono}%0A📍 *Dirección:* ${direccion}%0A📝 *Método de pago:* ${metodoPago}%0A%0A`;
      mensaje += `📦 *Productos:*%0A`;
      productos.forEach((p) => {
        mensaje += `• ${p.nombre} x${p.cantidad} - S/ ${(p.precio * p.cantidad).toFixed(2)}%0A`;
      });
      mensaje += `%0A💰 *Total:* S/ ${total.toFixed(2)}%0A📌 *Notas:* ${notas || 'Ninguna'}`;

      const numeroWhatsApp = "51999207025";
      const url = `https://wa.me/${numeroWhatsApp}?text=${mensaje}`;

      window.open(url, "_blank");
      localStorage.removeItem('carrito');
      document.getElementById('pedidoForm').reset();
      alert("✅ Tu pedido fue registrado correctamente.");
      location.reload();
    });
  </script>
</body>
</html>
